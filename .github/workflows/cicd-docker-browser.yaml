name: chrome-browser

on:
  push:
    branches: [ main ]
    tags: ['v*']
  pull_request:
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:

# -------------------------------------------------
# 1️⃣ Native Linux Build (Source of Truth)
# -------------------------------------------------
  build-native:
    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          python-version: "3.13"
          activate-environment: mlc-chat-venv
          channels: conda-forge
          channel-priority: strict

      - name: Install Build Dependencies
        shell: bash -l {0}
        run: |
          conda install -y -c conda-forge \
            "cmake>=3.24" \
            rust \
            git \
            numpy scipy psutil decorator attrs cloudpickle

      - name: Build TVM
        shell: bash -l {0}
        run: |
          cd 3rdparty/tvm
          mkdir -p build && cd build
          cmake .. \
            -DUSE_CUDA=OFF \
            -DUSE_CUBLAS=OFF \
            -DUSE_CUTLASS=OFF \
            -DBUILD_SHARED_LIBS=ON
          make -j$(nproc)

      - name: Build MLC-LLM Core
        shell: bash -l {0}
        run: |
          mkdir -p build && cd build
          cmake .. \
            -DUSE_CUDA=OFF \
            -DUSE_CUBLAS=OFF \
            -DUSE_CUTLASS=OFF \
            -DBUILD_SHARED_LIBS=ON
          make -j$(nproc)

      - name: Install Python Package
        shell: bash -l {0}
        run: |
          pip install -e python

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mlc-build
          path: |
            build
            3rdparty/tvm/build
            python


# -------------------------------------------------
# 2️⃣ Build & Push Docker Image (Packaging Only)
# -------------------------------------------------
  build-docker:
    needs: build-native
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}

    steps:
      - uses: actions/checkout@v4

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: mlc-build

      - name: Debug Artifact Structure
        run: ls -R

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract Metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}

      - name: Build and Push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}


# -------------------------------------------------
# 3️⃣ Test Inside Container
# -------------------------------------------------
  test:
    needs: build-docker
    runs-on: ubuntu-latest
    container:
      image: ${{ needs.build-docker.outputs.image_tag }}

    steps:
      - name: Validate Runtime
        run: |
          cd /opt/mlc-llm
          ls -l build
          python3 -c "import tvm; print('TVM OK')"
          python3 -c "import mlc_llm; print('MLC OK')"
          mlc_llm chat -h


# -------------------------------------------------
# 4️⃣ Publish Release (Tag Only)
# -------------------------------------------------
  publish-release:
    needs: test
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
