name: debug2

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-windows:
    runs-on: windows-2022
    timeout-minutes: 60

    defaults:
      run:
        shell: powershell

    env:
      SCCACHE_DIR: ${{ github.workspace }}\.sccache

    steps:
      # -------------------------------------------------
      # 1Ô∏è‚É£ Checkout repo
      # -------------------------------------------------
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      # -------------------------------------------------
      # 2Ô∏è‚É£ Cache Conda environment
      # -------------------------------------------------
      - name: Cache conda env
        uses: actions/cache@v4
        with:
          path: C:\Miniconda\envs\mlc-chat-venv
          key: conda-${{ runner.os }}-${{ hashFiles('**/environment.yml') }}
          restore-keys: |
            conda-${{ runner.os }}-

      # -------------------------------------------------
      # 3Ô∏è‚É£ Setup Conda
      # -------------------------------------------------
      - uses: conda-incubator/setup-miniconda@v3
        with:
          activate-environment: mlc-chat-venv
          environment-name: mlc-chat-venv
          python-version: "3.11"
          channels: conda-forge

      # -------------------------------------------------
      # 4Ô∏è‚É£ Install minimal deps
      # (skipped if cache restored)
      # -------------------------------------------------
      - name: Install deps
        run: |
          conda install -y `
            cmake>=3.24 `
            ninja `
            git `
            rust `
            numpy `
            pip

      # -------------------------------------------------
      # 5Ô∏è‚É£ Setup compiler cache (sccache)
      # -------------------------------------------------
      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.3

      - name: Cache sccache
        uses: actions/cache@v4
        with:
          path: .sccache
          key: sccache-${{ runner.os }}-${{ github.sha }}
          restore-keys: |
            sccache-${{ runner.os }}-

      # -------------------------------------------------
      # 6Ô∏è‚É£ Generate build config
      # -------------------------------------------------
      - name: Generate config
        run: python cmake/gen_cmake_config.py

      # -------------------------------------------------
      # 7Ô∏è‚É£ Cache build directory
      # -------------------------------------------------
      - name: Cache build folder
        uses: actions/cache@v4
        with:
          path: build
          key: build-${{ runner.os }}-${{ hashFiles('CMakeLists.txt') }}
          restore-keys: |
            build-${{ runner.os }}-

      # -------------------------------------------------
      # 8Ô∏è‚É£ Build runtime (fast mode)
      # -------------------------------------------------
      - name: Build MLC runtime
        run: |
          if (!(Test-Path build)) { mkdir build }
          cd build

          cmake .. `
            -G Ninja `
            -DCMAKE_BUILD_TYPE=Release `
            -DMLC_BUILD_RUNTIME_ONLY=ON `
            -DUSE_CUDA=OFF `
            -DUSE_VULKAN=OFF `
            -DUSE_METAL=OFF `
            -DUSE_LLVM=OFF `
            -DCMAKE_C_COMPILER_LAUNCHER=sccache `
            -DCMAKE_CXX_COMPILER_LAUNCHER=sccache

          cmake --build . --parallel $env:NUMBER_OF_PROCESSORS

      # -------------------------------------------------
      # 9Ô∏è‚É£ Install Python package
      # -------------------------------------------------
      - name: Install Python bindings
        run: pip install -e python

      # -------------------------------------------------
      # üîü Add DLL paths
      # -------------------------------------------------
      - name: Configure runtime paths
        run: |
          echo "$env:GITHUB_WORKSPACE\build" >> $env:GITHUB_PATH
          echo "$env:GITHUB_WORKSPACE\build\Release" >> $env:GITHUB_PATH

      # -------------------------------------------------
      # 11Ô∏è‚É£ Validate
      # -------------------------------------------------
      - name: Validate import + CLI
        run: |
          python -c "import mlc_llm; print('MLC import OK')"
          mlc_llm --help
