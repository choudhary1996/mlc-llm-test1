name: linux build

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  Build-on-server:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          python-version: "3.13"
          activate-environment: mlc-chat-venv
          channels: conda-forge
          channel-priority: strict

      - name: Install Build Dependencies
        shell: bash -l {0}
        run: |
          conda install -n mlc-chat-venv -c conda-forge \
            "cmake>=3.24" rust git numpy scipy psutil decorator attrs cloudpickle -y

      - name: Generate CMake config
        shell: bash -l {0}
        run: |
          printf "\nn\nn\nn\nn\nn\n" | python cmake/gen_cmake_config.py

      - name: Build TVM
        shell: bash -l {0}
        run: |
          cd 3rdparty/tvm
          mkdir -p build && cd build
          cmake .. \
            -DUSE_CUDA=OFF \
            -DUSE_CUBLAS=OFF \
            -DUSE_CUTLASS=OFF \
            -DBUILD_SHARED_LIBS=ON
          make -j$(nproc)

      - name: Build mlc-llm core
        shell: bash -l {0}
        run: |
          mkdir -p build && cd build
          cmake .. \
            -DUSE_CUDA=OFF \
            -DUSE_CUBLAS=OFF \
            -DUSE_CUTLASS=OFF \
            -DBUILD_SHARED_LIBS=ON
          make -j$(nproc)

      - name: Install MLC Python Package & Set Env
        shell: bash -l {0}
        run: |
          pip install -e python
          
          # Define paths
          TVM_HOME=$GITHUB_WORKSPACE/3rdparty/tvm
          
          # Persist variables for subsequent steps
          echo "TVM_HOME=$TVM_HOME" >> $GITHUB_ENV
          echo "PYTHONPATH=$GITHUB_WORKSPACE/python:$TVM_HOME/python:$PYTHONPATH" >> $GITHUB_ENV
          echo "LD_LIBRARY_PATH=$GITHUB_WORKSPACE/build:$TVM_HOME/build:$LD_LIBRARY_PATH" >> $GITHUB_ENV
          
          # Ensure the installed python scripts/binaries are in PATH
          echo "$(python -m site --user-base)/bin" >> $GITHUB_PATH

      - name: Verify Installation
        shell: bash -l {0}
        run: |
          python -c "import tvm; print('TVM loaded OK, version:', tvm.__version__)"
          python -c "import mlc_llm; print('MLC-LLM loaded OK')"
          mlc_llm chat --help
