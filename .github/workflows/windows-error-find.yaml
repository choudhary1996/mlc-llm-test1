name: windows-debug-build

on:
  push:
    branches: [ main ]
  workflow_dispatch:
#home
jobs:
  Build-and-Diagnose:
    runs-on: windows-2022
    timeout-minutes: 90 

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          python-version: "3.13"
          activate-environment: mlc-chat-venv

      - name: Install Dependencies
        shell: powershell
        run: |
          conda install -n mlc-chat-venv -c conda-forge `
            "cmake>=3.24" rust git numpy scipy psutil decorator attrs cloudpickle llvmdev=18 ninja `
            zlib libxml2 xz zstd pkg-config -y

      - name: Build TVM (Debug Mode)
        id: build_tvm
        continue-on-error: true
        shell: powershell
        run: |
          cd 3rdparty/tvm
          if (!(Test-Path build)) { mkdir build }
          cd build
          $CONDA_LIB = "$env:CONDA\envs\mlc-chat-venv\Library"
          cmake .. `
            -G "Visual Studio 17 2022" `
            -A x64 `
            -DUSE_CUDA=OFF `
            -DUSE_LLVM=ON `
            -DBUILD_SHARED_LIBS=ON `
            -DCMAKE_PREFIX_PATH="$CONDA_LIB" `
            -DLIBXML2_INCLUDE_DIR="$CONDA_LIB\include\libxml2" `
            -DLIBXML2_LIBRARY="$CONDA_LIB\lib\libxml2.lib"
          cmake --build . --config Release --parallel $env:NUMBER_OF_PROCESSORS

      - name: Build MLC-LLM (Debug Mode)
        id: build_mlc
        continue-on-error: true
        shell: powershell
        run: |
          if (!(Test-Path build)) { mkdir build }
          cd build
          cmake .. -G "Visual Studio 17 2022" -A x64 -DUSE_CUDA=OFF -DUSE_LLVM=ON
          cmake --build . --config Release --parallel $env:NUMBER_OF_PROCESSORS

      - name: Diagnostic: Check Missing Symbols/Libs
        if: always()
        shell: powershell
        run: |
          Write-Host "--- Environment Diagnostics ---"
          conda list
          Write-Host "--- Checking for Compiled DLLs ---"
          Get-ChildItem -Path ".\**\*.dll" -Recurse -ErrorAction SilentlyContinue | Select-Object FullName
          Write-Host "--- Checking Conda Library Folder for .lib files ---"
          $LIB_PATH = "$env:CONDA\envs\mlc-chat-venv\Library\lib"
          if (Test-Path $LIB_PATH) {
              ls $LIB_PATH\*.lib | Where-Object { $_.Name -match "xml2|zlib|zstd|lzma" }
          }

      - name: Final Validation
        if: always()
        shell: powershell
        run: |
          # The pipe character '|' above on line 66 (or equivalent) was likely missing
          $env:PYTHONPATH = "$env:GITHUB_WORKSPACE\python;$env:GITHUB_WORKSPACE\3rdparty\tvm\python"
          $env:PATH = "$env:GITHUB_WORKSPACE\build\Release;$env:GITHUB_WORKSPACE\3rdparty\tvm\build\Release;$env:PATH"
          
          Write-Host "--- Attempting Imports ---"
          python -c "import tvm; print('TVM Import Successful')"
          python -c "import mlc_llm; print('MLC Import Successful')"
