name: Windows-only
 
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
 
jobs:
  build:
    name: Build mlc_llm from source (Windows)
    runs-on: windows-latest
 
    defaults:
      run:
        shell: bash -l {0}
 
    steps:
      # 1Ô∏è‚É£ Checkout repository + submodules
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
 
      # 2Ô∏è‚É£ Setup Conda
      - name: Setup Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          auto-activate-base: false
          activate-environment: mlc-chat-venv
          python-version: 3.12
 
      # 3Ô∏è‚É£ Create build environment
      - name: Create build environment
        run: |
          conda create -y -n mlc-chat-venv -c conda-forge \
            "cmake>=3.24" \
            rust \
            git \
            python=3.12
 
      # 4Ô∏è‚É£ Generate CMake config
      - name: Generate CMake config
        run: |
          conda activate mlc-chat-venv
 
          mkdir -p build
          cd build
 
          printf "\nn\nn\nn\nn\nn\n" | python ../cmake/gen_cmake_config.py
 
      # 5Ô∏è‚É£ Build mlc_llm runtime
      - name: Build mlc_llm runtime
        run: |
          conda activate mlc-chat-venv
          cd build
 
          cmake ..
          cmake --build . --parallel
 
      # 5Ô∏è‚É£1Ô∏è‚É£ Normalize mlc_llm DLL paths
      - name: Normalize mlc_llm DLL paths
        run: |
          cd build
 
          for dir in Release RelWithDebInfo Debug; do
            if [ -d "$dir" ]; then
              cp $dir/*.dll . 2>/dev/null || true
            fi
          done
 
          echo "=== mlc_llm DLLs ==="
          ls -l *.dll || true
 
      # 6Ô∏è‚É£ Build TVM runtime
      - name: Build TVM runtime
        run: |
          conda activate mlc-chat-venv
          cd 3rdparty/tvm
 
          mkdir -p build
          cd build
 
          cmake ..
          cmake --build . --parallel
 
      # 6Ô∏è‚É£1Ô∏è‚É£ Normalize TVM DLL paths
      - name: Normalize TVM DLL paths
        run: |
          cd 3rdparty/tvm/build
 
          for dir in Release RelWithDebInfo Debug; do
            if [ -d "$dir" ]; then
              cp $dir/*.dll . 2>/dev/null || true
            fi
          done
 
          echo "=== TVM DLLs ==="
          ls -l *.dll || true
 
      # 7Ô∏è‚É£ Install TVM Python bindings
      - name: Install TVM Python bindings
        run: |
          conda activate mlc-chat-venv
          cd 3rdparty/tvm/python
          pip install -e .
 
      # 7Ô∏è‚É£1Ô∏è‚É£ FIX ‚Äî Install TVM FFI runtime (missing module fix)
      - name: Install TVM FFI runtime
        run: |
          conda activate mlc-chat-venv
          pip install apache-tvm-ffi==0.1.0b15
 
      # 8Ô∏è‚É£ Install mlc_llm Python package (skip heavy deps)
      - name: Install mlc_llm Python package
        run: |
          conda activate mlc-chat-venv
          cd python
          pip install -e . --no-deps
 
      # 9Ô∏è‚É£ Install minimal runtime dependencies (include pydantic to fix import error)
      - name: Install runtime Python dependencies
        run: |
          conda activate mlc-chat-venv
          pip install psutil numpy decorator attrs cloudpickle "pydantic>=2.0.0,<3.0.0"
 
      # üîü Export DLL paths
      - name: Export library paths
        run: |
          echo "PATH=$PATH:$(pwd)/build:$(pwd)/3rdparty/tvm/build" >> $GITHUB_ENV
 
      # 1Ô∏è‚É£1Ô∏è‚É£ Validate installation
      - name: Validate build
        run: |
          conda activate mlc-chat-venv
 
          echo "=== DLL check ==="
          ls build/*.dll
          ls 3rdparty/tvm/build/*.dll
 
          echo "=== Python import test ==="
          python -c "import tvm, tvm_ffi, mlc_llm; print('Imports OK')"
 
          echo "=== CLI test ==="
          mlc_llm chat -h
 
      # 1Ô∏è‚É£2Ô∏è‚É£ Upload artifacts
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mlc-llm-build-windows
          path: |
            build/
            3rdparty/tvm/build/
